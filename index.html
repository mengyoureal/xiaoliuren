<!-- START OF FILE 小瑕疵支付重新算版_终极优化版.html -->
<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>春风阁 - 道家秘传九神版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!-- 引入专业农历库 -->
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
  <!-- 引入 MD5 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.16.0/js/md5.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#FCD34D", 
            secondary: "#D8B4FE", 
            accent: "#1677FF", 
            bgStart: "#2E1065", 
            bgEnd: "#020617",   
          },
          fontFamily: {
            serif: ["Noto Serif SC", "STSong", "SimSun", "serif"],
            sans: ["PingFang SC", "Microsoft YaHei", "sans-serif"],
          },
          animation: {
            "fade-in": "fadeIn 1s ease-in-out",
            "slide-up": "slideUp 0.8s ease-out",
            "pulse-slow": "pulse 3s ease-in-out infinite",
            "float": "float 3s ease-in-out infinite",
            "scroll-left": "scrollLeft 60s linear infinite",
          },
          keyframes: {
            scrollLeft: {
              '0%': { transform: 'translateX(0)' },
              '100%': { transform: 'translateX(-50%)' },
            }
          }
        },
      },
    };
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
        .text-gold { color: #FCD34D; text-shadow: 0 0 8px rgba(252, 211, 77, 0.4); }
        .bg-mystic { background: radial-gradient(circle at top center, #3B0764 0%, #170526 60%, #000000 100%); }
        .card-glass { background: rgba(30, 20, 50, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(216, 180, 254, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .blur-lock { filter: blur(12px); user-select: none; pointer-events: none; transition: filter 0.8s ease; }
        .blur-unlock { filter: blur(0); user-select: auto; pointer-events: auto; }
        .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(10,5,20,0) 0%, rgba(10,5,20,0.95) 40%, rgba(10,5,20,1) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.5s ease; }
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    body { background-color: #020617; color: #E9D5FF; font-family: 'STSong', 'Noto Serif SC', serif; }
    .bagua-spinner { width: 70px; height: 70px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRkREMzREIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNTAgMiBBNDggNDggMCAwIDEgNTAgOTggQTQ4IDQ4IDAgMCAwIDUwIDIgWiIgZmlsbD0iI0ZERDM0RCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMjYiIHI9IjYiIGZpbGw9IiMzQjA3NjQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9Ijc0IiByPSI2IiBmaWxsPSIjRkREMzREIi8+PC9zdmc+'); animation: spin 3s linear infinite; margin: 0 auto; }
  </style>
</head>

<body class="bg-mystic min-h-screen font-serif text-gray-200">

  <!-- 顶部导航 (已更新：添加分享按钮) -->
  <div class="fixed top-0 w-full z-50 bg-[#170526]/80 backdrop-blur-md border-b border-purple-500/20">
    <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-xl mr-2 text-gold">☯</span>
        <span class="font-bold text-gold tracking-widest text-lg">春风阁</span>
      </div>
      <!-- 右侧功能区 -->
      <button onclick="sharePage()" class="flex items-center space-x-1 bg-gold/10 hover:bg-gold/20 active:scale-95 transition-all border border-gold/30 rounded-full px-3 py-1">
        <i class="fa fa-share-alt text-gold text-xs"></i>
        <span class="text-xs text-gold font-sans">保存/分享</span>
      </button>
    </div>
  </div>

  <!-- 主容器 -->
  <div class="max-w-md mx-auto pt-24 pb-24 px-4 relative">
    
    <!-- 头部标语 -->
    <div class="text-center mb-10 animate-fade-in">
      <h1 class="text-5xl font-bold text-gold mb-3 tracking-[0.2em]" style="text-shadow: 0 4px 20px rgba(147, 51, 234, 0.5);">
        问春风
      </h1>
      <p class="text-purple-200 text-sm font-sans opacity-90 tracking-[0.2em] uppercase">
        遇事不明 · 可问春风
      </p>
    </div>

    <!-- 实时日期展示 -->
    <div class="card-glass rounded-xl p-4 mb-8 text-center border-t border-purple-500/20">
        <div class="flex justify-between items-center text-sm font-sans text-purple-200">
            <div class="text-left opacity-90">
                <div class="text-xs mb-1 text-purple-400">阳历</div>
                <div id="solarDate" class="font-bold tracking-wide text-white"></div>
            </div>
            <div class="w-px h-8 bg-purple-500/30"></div>
            <div class="text-right opacity-90">
                <div class="text-xs mb-1 text-purple-400">农历 / 时辰</div>
                <div id="lunarDate" class="font-bold tracking-wide text-white"></div>
            </div>
        </div>
    </div>

    <!-- 核心输入区 -->
    <div id="inputSection" class="relative z-20">
      <div class="card-glass rounded-2xl p-6 shadow-2xl animate-slide-up">
        <div class="flex items-center mb-4">
            <div class="w-1 h-5 bg-gold mr-3 rounded-full shadow-[0_0_10px_#FCD34D]"></div>
            <h3 class="text-lg font-bold text-white tracking-wide">请诚心写下疑惑</h3>
        </div>
        <textarea id="questionInput" 
          placeholder="例如：
• 这一份工作该不该换？
• 那个TA是不是我的正缘？
• 最近财运有些低迷，如何化解？
• 下个月准备创业，时机对吗？

(心中默念三遍，诚心发问)"
          class="w-full h-36 bg-[#0F0518]/60 border border-purple-500/30 rounded-xl p-4 text-purple-100 focus:border-gold/60 focus:ring-1 focus:ring-gold/60 outline-none transition-all placeholder-purple-400/30 font-sans text-base resize-none"></textarea>
        
        <div class="mt-6">
            <button onclick="startAnalysisFlow()"
              class="w-full bg-gradient-to-r from-purple-900 via-purple-800 to-purple-900 hover:from-purple-800 hover:to-purple-700 text-gold font-bold py-4 rounded-xl shadow-[0_4px_20px_rgba(88,28,135,0.4)] border border-purple-500/30 active:scale-95 transition-all flex items-center justify-center group relative overflow-hidden">
              <div class="absolute inset-0 bg-gold/5 opacity-0 group-hover:opacity-20 transition-opacity"></div>
              <span class="text-lg tracking-[0.3em] group-hover:scale-105 transition-transform">排盘推演</span>
              <i class="fa fa-angle-right ml-2 group-hover:translate-x-1 transition-transform"></i>
            </button>
            <p class="text-center text-xs text-purple-400/60 mt-4 font-sans flex justify-center items-center">
                <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                今日已有 <span class="text-gold font-bold mx-1" id="visitorCount">1,208</span> 人获取指引
            </p>
        </div>
      </div>
    </div>

    <!-- 加载中动画 -->
    <div id="loadingState" class="hidden py-16 text-center">
        <div class="bagua-spinner mb-8"></div>
        <p class="text-gold text-2xl mb-3 font-serif tracking-widest">紫微斗数 天机推演</p>
        <p class="text-purple-300 text-sm font-sans animate-pulse tracking-wider opacity-80" id="loadingText">深度测算中，预计需要30秒...</p>
    </div>

    <!-- 结果展示区 -->
    <div id="resultSection" class="hidden animate-fade-in">
        
        <!-- 免费：卦象展示 + 现状分析 -->
        <div class="card-glass rounded-xl p-5 mb-4">
            <!-- 卦象 -->
            <div class="text-center mb-6">
                <span class="bg-purple-900/40 text-gold px-6 py-1.5 rounded-full text-xs border border-purple-500/30 tracking-[0.2em] uppercase">当前时空卦象</span>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">初象(月)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod1">--</div>
                </div>
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">中象(日)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod2">--</div>
                </div>
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">末象(时)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod3">--</div>
                </div>
            </div>
            
            <!-- 免费分析部分 -->
            <div class="mb-2">
                <div class="flex items-center mb-3 border-l-4 border-gold pl-3">
                    <h3 class="text-lg font-bold text-white tracking-wide">卦意直断</h3>
                </div>
                <div id="freeAnalysisContent" class="text-purple-100 text-[15px] leading-8 text-justify font-serif opacity-90 min-h-[100px]">
                    <!-- AI生成的免费部分 -->
                </div>
            </div>
        </div>

        <!-- 付费墙区域 -->
        <div id="paidContentContainer" class="relative overflow-hidden rounded-2xl border border-purple-500/30 shadow-[0_0_40px_rgba(0,0,0,0.6)]">
            
            <!-- 内容层 (模糊) -->
            <div id="paidContentBlur" class="bg-white/5 p-8 blur-lock">
                <h3 class="font-bold text-xl mb-4 text-gold flex items-center border-l-4 border-gold pl-3">
                    大师锦囊
                </h3>
                <div id="paidAnalysisContent" class="text-purple-100 text-[15px] leading-relaxed opacity-80">
                    <!-- 占位符 -->
                    <p class="mb-4">根据卦象显示，您接下来需要特别注意的时间点是...</p>
                    <p class="mb-4">在行动方向上，建议向...</p>
                </div>
            </div>

            <!-- 遮罩层 (按钮) -->
            <div id="payOverlay" class="lock-overlay p-4 text-center">
                <div class="mb-6 animate-float">
                    <div class="w-14 h-14 bg-gradient-to-br from-purple-600 to-purple-900 rounded-full flex items-center justify-center mx-auto mb-3 shadow-[0_0_20px_rgba(147,51,234,0.5)] border border-gold/30">
                        <i class="fa fa-lock text-2xl text-gold"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1 tracking-wide">解锁实操建议</h3>
                    <p class="text-purple-300 text-xs opacity-70">深度解析 · 破局之法</p>
                </div>
                
                <!-- 价格按钮网格 -->
                <div class="grid grid-cols-2 gap-3 w-full mb-4 px-2">
                    <button id="btn-tier-1" onclick="startPayment('1.68')" class="bg-black/60 border border-purple-500/30 hover:border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold" id="price-tier-1">¥ 1.68</span>
                        <span class="text-[10px] text-gray-400" id="label-tier-1">初探天机</span>
                    </button>
                    <button onclick="startPayment('6.66')" class="bg-gradient-to-br from-purple-900 to-purple-800 border border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95 relative overflow-hidden shadow-lg">
                        <div class="absolute top-0 right-0 bg-[#FCD34D] text-purple-900 font-bold text-[9px] px-1.5 rounded-bl-lg">荐</div>
                        <span class="text-xl font-bold text-white">¥ 6.66</span>
                        <span class="text-[10px] text-gold/80">祈愿顺遂</span>
                    </button>
                    <button onclick="startPayment('8.88')" class="bg-black/60 border border-purple-500/30 hover:border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold">¥ 8.88</span>
                        <span class="text-[10px] text-gray-400">心诚则灵</span>
                    </button>
                    <button onclick="startPayment('88.00')" class="bg-black/60 border border-gold/30 hover:border-gold text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold">¥ 88.00</span>
                        <span class="text-[10px] text-gray-400">大德圆满</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-center text-[10px] text-purple-400/50 mt-3">
                    <i class="fa fa-shield mr-1"></i>
                    <span>支持支付宝 · 隐私严格保密</span>
                </div>
            </div>
        </div>

        <!-- 结果操作按钮 -->
        <div id="resultActions" class="mt-6 flex space-x-3 hidden">
            <button onclick="copyResult()" class="flex-1 bg-white/5 hover:bg-white/10 text-purple-200 py-3 rounded-lg text-sm transition-colors border border-white/10">
                <i class="fa fa-copy mr-1"></i> 复制完整批注
            </button>
            <button onclick="location.href=location.pathname" class="flex-1 bg-gold/20 hover:bg-gold/30 text-gold py-3 rounded-lg text-sm transition-colors border border-gold/30">
                <i class="fa fa-refresh mr-1"></i> 再测一事
            </button>
        </div>
    </div>
    
    <!-- 底部滚动好评 -->
    <div class="fixed bottom-0 left-0 right-0 bg-[#0F0518]/90 backdrop-blur border-t border-purple-500/20 py-2 z-40" id="socialProof">
        <div class="relative w-full overflow-hidden h-6">
            <div id="marqueeContent" class="absolute whitespace-nowrap animate-scroll-left text-xs text-purple-300/60 font-sans flex items-center space-x-12 px-4">
                <!-- 内容将由JS动态生成 -->
            </div>
        </div>
    </div>
  </div>

  <script>
    // --- 【核心配置】 ---
    const CONFIG = {
        freeCode: "xiaoliuren.xyz", 
        discountCode: "可问春风",   
        discountPrice: "1.00",      
        vipCodes: ["xiaoliuren.xyz", "可问春风"],
        
        apiToken: "sk-zhkdhbaohshweaxxzxlvvucvklmlwsepbzmmghkxxkrfwpli", 
        paymentId: "2025111020404744", 
        paymentKey: "6Ecg3jrd3W4jcOADKclHaU0N5AsWftbB", 
        notifyUrl: "http://www.xiaoliuren.xyz", 
        submitUrl: "https://z-pay.cn/submit.php"
    };

    const NINE_GODS = [
      { name: "大安", type: "吉" }, { name: "留连", type: "平" }, { name: "速喜", type: "吉" },
      { name: "赤口", type: "凶" }, { name: "小吉", type: "吉" }, { name: "空亡", type: "凶" },
      { name: "病符", type: "凶" }, { name: "桃花", type: "平" }, { name: "天德", type: "吉" }
    ];
    const SHICHEN = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];

    let currentStages = []; 
    let userQuestion = "";  

    document.addEventListener("DOMContentLoaded", function () {
      updateTimeDisplay();
      setInterval(updateTimeDisplay, 1000); 
      generateDailyVisitorCount();
      generateRealisticMarquee();
      checkPaymentResult();
    });

    // --- 0. 分享功能 (新增) ---
    function sharePage() {
        const url = window.location.href.split('?')[0]; // 去除参数分享纯净链接
        navigator.clipboard.writeText(url).then(() => {
            alert("✅ 网页链接已复制\n请粘贴分享给朋友");
        }).catch(() => {
            prompt("请长按复制链接：", url);
        });
    }

    // --- 1. 每日动态人数 ---
    function generateDailyVisitorCount() {
        const now = new Date();
        const seed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const baseCount = 1050 + (dayOfYear * 15); 
        const dynamicPart = now.getHours() * 8 + now.getMinutes(); 
        const finalCount = baseCount + dynamicPart;
        document.getElementById("visitorCount").innerText = finalCount.toLocaleString();
    }

    // --- 2. 真实感无限滚动弹幕 ---
    function generateRealisticMarquee() {
        const actions = ["解锁了 事业运势报告", "查看了 感情复合分析", "咨询了 财运走向", "解锁了 每日吉凶", "查看了 婚姻匹配度", "咨询了 跳槽建议", "解锁了 健康运势"];
        const times = ["刚刚", "1分钟前", "2分钟前", "刚刚", "3分钟前", "5分钟前"];
        let contentHtml = "";
        
        function getRandomId() {
            const start = Math.floor(Math.random() * 9 + 1); 
            const end = Math.random() > 0.5 ? Math.floor(Math.random() * 10) : String.fromCharCode(97 + Math.floor(Math.random() * 6)); 
            return `${start}***${end}`;
        }

        for (let i = 0; i < 20; i++) {
            const userId = getRandomId();
            const action = actions[Math.floor(Math.random() * actions.length)];
            const time = times[Math.floor(Math.random() * times.length)];
            contentHtml += `
                <span class="flex items-center">
                    <span class="text-purple-400/50 mr-2">[${time}]</span>
                    <span class="text-purple-300/80">支付宝用户 ${userId}</span>
                    <span class="text-white ml-1 opacity-90">${action}</span>
                </span>
            `;
        }
        document.getElementById("marqueeContent").innerHTML = contentHtml + contentHtml;
    }

    // --- 3. 时间与起卦 ---
    function updateTimeDisplay() {
        const now = new Date();
        const solar = Solar.fromDate(now);
        const lunar = solar.getLunar();
        
        document.getElementById("solarDate").innerText = `${solar.getYear()}年${solar.getMonth()}月${solar.getDay()}日`;
        
        const lunarMonth = lunar.getMonth(); 
        const lunarDay = lunar.getDay();     
        const hour = now.getHours();
        let shichenIdx = Math.floor((hour + 1) / 2) % 12;
        const shichenName = SHICHEN[shichenIdx] + "时";
        
        document.getElementById("lunarDate").innerText = `农历${lunar.getMonthInChinese()}月${lunar.getDayInChinese()} ${shichenName}`;
        
        const m = Math.abs(lunarMonth); 
        const d = lunarDay;
        const t = shichenIdx + 1; 
        
        const s1 = (m - 1) % 9;
        const s2 = (s1 + d - 1) % 9;
        const s3 = (s2 + t - 1) % 9;
        
        currentStages = [NINE_GODS[s1], NINE_GODS[s2], NINE_GODS[s3]];
    }

    // --- 4. 交互流程 ---
    async function startAnalysisFlow() {
        let rawInput = document.getElementById("questionInput").value.trim();
        if (rawInput.length < 2) {
            alert("请诚心输入您想测算的问题");
            return;
        }

        // 老板通道 (Free)
        if (rawInput.toLowerCase().includes(CONFIG.freeCode.toLowerCase())) {
            userQuestion = rawInput.replace(new RegExp(CONFIG.freeCode, "gi"), "").trim();
            if(!userQuestion) userQuestion = "综合运势详解";
            await handleProcess(true);
            return;
        }

        // 正常/粉丝通道 (Need Pay)
        userQuestion = rawInput;
        await handleProcess(false);
    }

    async function handleProcess(isUnlocked) {
        document.getElementById("inputSection").classList.add("hidden");
        document.getElementById("loadingState").classList.remove("hidden");
        document.getElementById("socialProof").classList.add("hidden"); 

        const loadingTexts = [
            "正在沟通天地...", 
            "正在排盘推演 (预计需30秒)...",
            "正在连接时空能量...", 
            "大师正在深度解析...",
            "正在撰写实操建议...",
            "即将完成..."
        ];
        let step = 0;
        const loadingInterval = setInterval(() => {
            if(step < loadingTexts.length) {
                document.getElementById("loadingText").innerText = loadingTexts[step];
                step++;
            }
        }, 3000); 

        try {
            const minWait = new Promise(resolve => setTimeout(resolve, 3000));
            const aiTask = callAI(isUnlocked);
            
            await Promise.all([minWait, aiTask]);
            
            clearInterval(loadingInterval);
            showResultPage(isUnlocked);
            
        } catch (error) {
            console.error("流程异常，启用本地兜底", error);
            clearInterval(loadingInterval);
            showResultPage(isUnlocked);
        }
    }

    function showResultPage(isUnlocked) {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("resultSection").classList.remove("hidden");
        
        // 确保卦象显示正确 (如果是新算的，currentStages已经更新；如果是缓存的，会由checkPaymentResult处理覆盖)
        if(currentStages && currentStages.length > 0) {
            document.getElementById("teaserGod1").innerText = currentStages[0].name;
            document.getElementById("teaserGod2").innerText = currentStages[1].name;
            document.getElementById("teaserGod3").innerText = currentStages[2].name;
        }
        
        if(isUnlocked) {
            unlockContent();
        } else {
            // 检查粉丝特权
            const rawQ = document.getElementById("questionInput").value.trim();
            if (rawQ.toLowerCase().includes(CONFIG.discountCode.toLowerCase())) {
                const btn1 = document.getElementById("btn-tier-1");
                const price1 = document.getElementById("price-tier-1");
                const label1 = document.getElementById("label-tier-1");
                
                price1.innerText = "¥ " + CONFIG.discountPrice;
                price1.classList.add("text-red-400");
                label1.innerText = "粉丝特权";
                label1.classList.add("text-red-300");
                
                btn1.onclick = function() { startPayment(CONFIG.discountPrice); };
                btn1.classList.add("border-red-500/50"); 
            }
        }
    }

    function unlockContent() {
        const blurEl = document.getElementById("paidContentBlur");
        const overlayEl = document.getElementById("payOverlay");
        
        blurEl.classList.remove("blur-lock");
        blurEl.classList.add("blur-unlock");
        blurEl.style.opacity = "1";
        
        overlayEl.style.opacity = "0";
        setTimeout(() => {
            overlayEl.style.display = "none";
        }, 500);
        
        document.getElementById("resultActions").classList.remove("hidden");
    }

    // --- 5. 支付逻辑 ---
    function startPayment(amount) {
        let finalQ = userQuestion;
        CONFIG.vipCodes.forEach(code => {
             finalQ = finalQ.replace(new RegExp(code, "gi"), "");
        });
        if(!finalQ.trim()) finalQ = "综合运势分析";

        localStorage.setItem('cf_question', finalQ);

        const baseUrl = window.location.href.split('?')[0];
        const returnUrl = `${baseUrl}?status=paid`; 

        const payData = {
            pid: CONFIG.paymentId,
            money: amount, 
            name: "春风阁VIP深度测算报告",
            notify_url: CONFIG.notifyUrl,
            out_trade_no: new Date().getTime() + Math.floor(Math.random() * 1000),
            return_url: returnUrl,
            sitename: "春风阁",
            type: "alipay" 
        };

        const sortedParams = Object.keys(payData).sort().map(k => `${k}=${payData[k]}`).join('&');
        const paySign = md5(sortedParams + CONFIG.paymentKey);
        payData.sign = paySign;
        payData.sign_type = "MD5";

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = CONFIG.submitUrl;
        form.target = '_self'; 
        
        Object.keys(payData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = payData[key];
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }

    // --- 6. 支付回调 (优先读取缓存) ---
    function checkPaymentResult() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('status') === 'paid') {
            
            const cachedGods = localStorage.getItem('cf_cached_gods');
            const cachedFree = localStorage.getItem('cf_cached_free');
            const cachedPaid = localStorage.getItem('cf_cached_paid');

            if (cachedGods && cachedFree && cachedPaid) {
                // 1. 隐藏输入区，显示结果区
                document.getElementById("inputSection").classList.add("hidden");
                document.getElementById("loadingState").classList.add("hidden");
                document.getElementById("resultSection").classList.remove("hidden");
                document.getElementById("socialProof").classList.add("hidden");

                // 2. 恢复卦象
                const gods = JSON.parse(cachedGods);
                document.getElementById("teaserGod1").innerText = gods[0].name;
                document.getElementById("teaserGod2").innerText = gods[1].name;
                document.getElementById("teaserGod3").innerText = gods[2].name;

                // 3. 恢复文字内容
                document.getElementById("freeAnalysisContent").innerHTML = cachedFree;
                document.getElementById("paidAnalysisContent").innerHTML = cachedPaid;

                // 4. 直接解锁
                unlockContent();

                // 5. 清理URL
                window.history.replaceState({}, document.title, window.location.pathname);
            } else {
                const storedQuestion = localStorage.getItem('cf_question');
                if (storedQuestion) {
                    userQuestion = storedQuestion;
                    handleProcess(true);
                }
            }
        }
    }

    // --- 7. AI请求逻辑 (Prompt已深度优化) ---
    async function callAI(isUnlocked) {
        updateTimeDisplay(); 
        const now = new Date();
        const fullDateString = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
        
        let cleanQuestion = userQuestion;
        CONFIG.vipCodes.forEach(code => {
             cleanQuestion = cleanQuestion.replace(new RegExp(code, "gi"), "");
        });
        if(!cleanQuestion.trim()) cleanQuestion = "综合运势详解";

        const SPLIT_TAG = "|||SPLIT|||"; 
        
        // 兜底文案
        const fallbackFree = `<p><strong>【卦象直断】</strong>缘主所问之事，卦象显示目前处于“守势”。虽心有不甘，但时机未到，不可强求。建议静待花开，切勿急躁。</p>`;
        const fallbackPaid = `<h4>【大白话解盘】</h4><p>这卦的意思就是让你先别乱动。你现在越急，错得越多。</p><h4>【实操指南】</h4><ul><li><strong>具体做法：</strong> 这三天内，如果是工作上的事，只做执行，别提意见；如果是感情，别发长篇大论的消息。</li><li><strong>找谁帮忙：</strong> 往南边走，或者找属马、属蛇的朋友聊聊，他们能给你破局。</li><li><strong>开运物：</strong> 随身带个红色的打火机或中国结。</li></ul>`;

        const prompt = `
        你是一位道行高深、但说话非常接地气的道长。缘主正在为此事发愁："${cleanQuestion}"。
        
        **基本信息：**
        - 卦象：${currentStages[0].name} -> ${currentStages[1].name} -> ${currentStages[2].name}
        - 时间：${fullDateString}
        
        请严格按以下格式输出，两部分用 "${SPLIT_TAG}" 分隔：
        
        第一部分（免费可见，极度精简，约100-120字）：
        1. **【直断】**：针对问题"${cleanQuestion}"，直接给结论（是/否/吉/凶）。不要模棱两可。
        2. **【现状】**：一针见血地指出他现在最难受的点在哪里（比如“你现在是不是觉得进退两难？”）。
        (要求：紧扣问题，不废话，不打官腔)
        
        ${SPLIT_TAG}
        
        第二部分（付费解锁，大白话，操作性极强，约300字）：
        1. **【大师说人话】**：抛开那些晦涩的术语，用最通俗的大白话（口语化）解释为什么是这个结果。就像老朋友聊天一样。
        2. **【实操指南（重点）】**：
           - **此时此刻怎么做？** (给出极其具体的动词，例如：马上给那个人打电话/立刻停止投资/明天早上9点去哪里)。
           - **找谁帮忙？** (具体到方位、属相或特征，如“戴眼镜的胖子”)。
           - **必做之事：** (比如“穿红内裤”、“桌上摆一杯水”)。
        3. **【避坑细节】**：明确指出最近3天绝对不能做的一件事。
        (使用HTML <h4>, <p>, <ul>, <li> 排版，确保手机阅读舒适)
        `;

        try {
            const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${CONFIG.apiToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "deepseek-ai/DeepSeek-V3",
                    messages: [
                        {role: "system", content: "你是一位精通易理的智者，说话通俗易懂，擅长给出具体行动建议。"},
                        {role: "user", content: prompt}
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            const data = await response.json();
            if (data.choices && data.choices[0]) {
                const content = data.choices[0].message.content;
                const parts = content.split(SPLIT_TAG);
                
                const freeC = parts[0] || fallbackFree;
                const paidC = parts[1] || fallbackPaid;
                
                // === 生成后立即缓存 ===
                localStorage.setItem('cf_cached_gods', JSON.stringify(currentStages));
                localStorage.setItem('cf_cached_free', freeC);
                localStorage.setItem('cf_cached_paid', paidC);

                document.getElementById("freeAnalysisContent").innerHTML = freeC;
                document.getElementById("paidAnalysisContent").innerHTML = paidC;
            } else {
                throw new Error("AI Empty Response");
            }

        } catch (e) {
            console.error("AI Error, using fallback", e);
            document.getElementById("freeAnalysisContent").innerHTML = fallbackFree;
            document.getElementById("paidAnalysisContent").innerHTML = fallbackPaid;
            
            localStorage.setItem('cf_cached_gods', JSON.stringify(currentStages));
            localStorage.setItem('cf_cached_free', fallbackFree);
            localStorage.setItem('cf_cached_paid', fallbackPaid);
        }
    }

    function copyResult() {
        const t1 = document.getElementById("freeAnalysisContent").innerText;
        const t2 = document.getElementById("paidAnalysisContent").innerText;
        const tempInput = document.createElement("textarea");
        tempInput.value = "【春风阁·问春风】\n" + t1 + "\n\n【大师锦囊】\n" + t2 + "\n\n测算链接：" + window.location.href.split('?')[0];
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert("完整批注已复制，可粘贴分享");
    }
  </script>
</body>
</html>
<!-- END OF FILE -->
