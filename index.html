<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>春风阁 - 道家秘传九神版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!-- 引入专业农历库 -->
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
  <!-- 引入 MD5 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.16.0/js/md5.js"></script>
  <!-- 引入 Supabase 客户端 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#FCD34D", // 琥珀金
            secondary: "#D8B4FE", // 薰衣草紫
            darkbg: "#0C1816", // 极深墨绿
            paper: "#152623", // 卡片背景
            accent: "#1677FF", // 支付宝蓝
          },
          fontFamily: {
            serif: ["Noto Serif SC", "STSong", "SimSun", "serif"],
            sans: ["PingFang SC", "Microsoft YaHei", "sans-serif"],
          },
          animation: {
            "fade-in": "fadeIn 1s ease-in-out",
            "slide-up": "slideUp 0.8s ease-out",
            "pulse-slow": "pulse 3s ease-in-out infinite",
          },
        },
      },
    };
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
        .text-gold { color: #FCD34D; text-shadow: 0 0 8px rgba(252, 211, 77, 0.4); }
        .bg-mystic { background: radial-gradient(circle at top center, #3B0764 0%, #170526 60%, #000000 100%); }
        .card-glass { background: rgba(30, 20, 50, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(216, 180, 254, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .blur-lock { filter: blur(12px); user-select: none; pointer-events: none; }
        
        /* 模态框样式 */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); display: flex; align-items: center; justify-content: center; z-index: 100; transition: opacity 0.3s; }
        .modal-content { background: #152623; border: 1px solid #FCD34D; border-radius: 16px; padding: 24px; width: 90%; max-width: 360px; position: relative; text-align: center; }
    }
    body { background-color: #020617; color: #E9D5FF; font-family: 'STSong', 'Noto Serif SC', serif; }
    .bagua-spinner { width: 60px; height: 60px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRkREMzREIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNTAgMiBBNDggNDggMCAwIDEgNTAgOTggQTQ4IDQ4IDAgMCAwIDUwIDIgWiIgZmlsbD0iI0ZERDM0RCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMjYiIHI9IjYiIGZpbGw9IiMzQjA3NjQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9Ijc0IiByPSI2IiBmaWxsPSIjRkREMzREIi8+PC9zdmc+'); animation: spin 3s linear infinite; margin: 0 auto; }
  </style>
</head>

<body class="bg-mystic min-h-screen font-serif text-gray-200">

  <!-- 顶部导航 -->
  <div class="fixed top-0 w-full z-50 bg-[#170526]/80 backdrop-blur-md border-b border-purple-500/20">
    <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-xl mr-2 text-gold">☯</span>
        <span class="font-bold text-gold tracking-widest text-lg">春风阁</span>
      </div>
      
      <!-- 用户状态区 -->
      <div id="userSection" class="flex items-center space-x-3">
        <!-- 未登录显示 -->
        <button id="btnLogin" onclick="showAuthModal()" class="text-sm text-gold border border-gold/50 px-3 py-1 rounded-full hover:bg-gold/10 transition">
          登录/注册
        </button>
        
        <!-- 已登录显示 (默认隐藏) -->
        <div id="userInfo" class="hidden flex items-center space-x-2">
            <span class="text-xs text-purple-300">缘分值: <strong id="creditCount" class="text-gold text-lg">0</strong></span>
            <i class="fa fa-user-circle text-xl text-gold cursor-pointer" onclick="showProfileModal()"></i>
        </div>
      </div>
    </div>
  </div>

  <!-- 主容器 -->
  <div class="max-w-md mx-auto pt-24 pb-24 px-4 relative">
    
    <!-- 头部标语 -->
    <div class="text-center mb-10 animate-fade-in">
      <h1 class="text-5xl font-bold text-gold mb-3 tracking-[0.2em]" style="text-shadow: 0 4px 20px rgba(147, 51, 234, 0.5);">
        问春风
      </h1>
      <p class="text-purple-200 text-sm font-sans opacity-90 tracking-[0.2em]">
        注册即送 1 次 · 邀请得 2 次
      </p>
    </div>

    <!-- 核心输入区 -->
    <div id="inputSection" class="relative z-20">
      <div class="card-glass rounded-2xl p-6 shadow-2xl">
        <div class="flex items-center mb-4">
            <div class="w-1 h-5 bg-gold mr-3 rounded-full"></div>
            <h3 class="text-lg font-bold text-white tracking-wide">请诚心写下疑惑</h3>
        </div>
        <textarea id="questionInput" placeholder="例如：这份工作该不该换？那个TA是不是正缘？(心中默念三遍)" class="w-full h-36 bg-[#0F0518]/60 border border-purple-500/30 rounded-xl p-4 text-purple-100 focus:border-gold/60 outline-none text-base resize-none"></textarea>
        
        <div class="mt-6">
            <button onclick="checkCreditsAndStart()" class="w-full bg-gradient-to-r from-purple-900 via-purple-800 to-purple-900 hover:from-purple-800 hover:to-purple-700 text-gold font-bold py-4 rounded-xl shadow-lg border border-purple-500/30 active:scale-95 transition-all">
              <span class="text-lg tracking-[0.3em]">排盘推演</span>
            </button>
        </div>
      </div>
    </div>

    <!-- 加载中动画 -->
    <div id="loadingState" class="hidden py-16 text-center">
        <div class="bagua-spinner mb-8"></div>
        <p class="text-gold text-2xl mb-3 font-serif tracking-widest">紫微斗数 天机推演</p>
        <p class="text-purple-300 text-sm font-sans animate-pulse" id="loadingText">深度测算中...</p>
    </div>

    <!-- 结果展示区 (完全不模糊，只要有积分就能看) -->
    <div id="resultSection" class="hidden animate-fade-in">
        <div class="card-glass rounded-xl p-6 border border-secondary/20">
            <div class="text-center mb-6">
                <span class="bg-purple-900/40 text-gold px-6 py-1.5 rounded-full text-xs border border-purple-500/30 tracking-[0.2em]">当前时空卦象</span>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                <div class="bg-black/30 p-3 rounded-lg"><div class="text-xs text-purple-400 mb-1">初象</div><div class="text-xl font-bold text-white" id="god1">--</div></div>
                <div class="bg-black/30 p-3 rounded-lg"><div class="text-xs text-purple-400 mb-1">中象</div><div class="text-xl font-bold text-white" id="god2">--</div></div>
                <div class="bg-black/30 p-3 rounded-lg"><div class="text-xs text-purple-400 mb-1">末象</div><div class="text-xl font-bold text-white" id="god3">--</div></div>
            </div>
            
            <div class="mb-4 border-l-4 border-gold pl-4">
                <h3 class="text-lg font-bold text-white">大师完整批注</h3>
            </div>
            <div id="aiContent" class="text-purple-100 text-[15px] leading-8 text-justify font-serif opacity-90 min-h-[200px]"></div>
            
            <div class="mt-8 flex space-x-3">
                <button onclick="location.reload()" class="flex-1 bg-gold/20 hover:bg-gold/30 text-gold py-3 rounded-lg text-sm">再测一事</button>
            </div>
        </div>
    </div>

  </div>

  <!-- === 弹窗组件 === -->

  <!-- 1. 登录注册弹窗 -->
  <div id="authModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="text-right mb-2"><i class="fa fa-times text-gray-400 cursor-pointer" onclick="closeModal('authModal')"></i></div>
        <h3 class="text-xl font-bold text-gold mb-6">缘主请留步</h3>
        <p class="text-xs text-purple-300 mb-4">注册即送 1 次免费测算机会</p>
        
        <input type="email" id="emailInput" placeholder="请输入邮箱" class="w-full bg-black/50 border border-purple-500/30 rounded-lg p-3 text-white mb-3 outline-none">
        <input type="password" id="passwordInput" placeholder="设置密码" class="w-full bg-black/50 border border-purple-500/30 rounded-lg p-3 text-white mb-4 outline-none">
        
        <button onclick="handleRegister()" class="w-full bg-gold text-black font-bold py-3 rounded-lg mb-3">注册 (送1次)</button>
        <button onclick="handleLogin()" class="w-full bg-transparent border border-gold text-gold py-3 rounded-lg">已有账号登录</button>
    </div>
  </div>

  <!-- 2. 余额不足/充值弹窗 -->
  <div id="creditModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="text-right mb-2"><i class="fa fa-times text-gray-400 cursor-pointer" onclick="closeModal('creditModal')"></i></div>
        <h3 class="text-xl font-bold text-gold mb-2">缘分值不足</h3>
        <p class="text-xs text-purple-300 mb-6">每次测算消耗 1 点缘分值</p>
        
        <!-- 选项A：付费 -->
        <div class="bg-black/40 p-4 rounded-lg border border-gold/30 mb-4 cursor-pointer hover:border-gold" onclick="startPayment()">
            <div class="flex justify-between items-center">
                <div class="text-left">
                    <div class="text-white font-bold">随喜润金</div>
                    <div class="text-xs text-gray-400">立即获得 1 次额度</div>
                </div>
                <div class="text-xl text-gold font-bold">¥ 1.88</div>
            </div>
        </div>
        
        <div class="flex items-center justify-center my-3">
            <span class="h-px bg-white/10 w-12"></span>
            <span class="text-xs text-gray-500 mx-2">或者</span>
            <span class="h-px bg-white/10 w-12"></span>
        </div>

        <!-- 选项B：推广 -->
        <div class="bg-gradient-to-r from-purple-900 to-indigo-900 p-4 rounded-lg border border-purple-500/30">
            <div class="text-left mb-2">
                <div class="text-white font-bold">邀请好友 (得2次)</div>
                <div class="text-xs text-purple-200">好友注册并付费，您得 2 次</div>
            </div>
            <div class="flex space-x-2">
                <input type="text" id="shareLinkInput" readonly class="flex-1 bg-black/50 text-xs text-gray-300 p-2 rounded border border-white/10">
                <button onclick="copyShareLink()" class="bg-gold text-black text-xs px-3 rounded font-bold">复制</button>
            </div>
        </div>
    </div>
  </div>

  <!-- 3. 个人中心弹窗 -->
  <div id="profileModal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="text-right mb-2"><i class="fa fa-times text-gray-400 cursor-pointer" onclick="closeModal('profileModal')"></i></div>
        <h3 class="text-xl font-bold text-gold mb-6">我的道缘</h3>
        
        <div class="bg-black/30 p-4 rounded-lg mb-4">
            <div class="text-sm text-gray-400 mb-1">当前剩余缘分值</div>
            <div class="text-4xl font-bold text-gold" id="profileCredits">0</div>
        </div>
        
        <div class="text-left text-sm text-gray-300 mb-6 space-y-2">
            <p>我的账号：<span id="profileEmail">--</span></p>
            <p>我的邀请码：<span id="profileCode" class="text-gold">--</span></p>
        </div>
        
        <button onclick="handleLogout()" class="w-full bg-red-900/50 text-red-300 border border-red-900 py-3 rounded-lg">退出登录</button>
    </div>
  </div>

  <script>
    // --- 1. 配置项 (填入你的 Key) ---
    const SUPABASE_URL = 'https://whlimmxqbzcnsvrtbubr.supabase.co';
    const SUPABASE_KEY = 'sb_publishable_kAUj3EjUUpqXYLDwcaBXiw_OryfJflY'; // 你的 Key
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const CONFIG = {
        apiToken: "sk-zhkdhbaohshweaxxzxlvvucvklmlwsepbzmmghkxxkrfwpli", 
        paymentId: "2025111020404744", 
        paymentKey: "6Ecg3jrd3W4jcOADKclHaU0N5AsWftbB", 
        submitUrl: "https://z-pay.cn/submit.php"
    };

    let currentUser = null;
    let userProfile = null;

    // --- 2. 初始化逻辑 ---
    document.addEventListener("DOMContentLoaded", async function () {
        // 检查登录状态
        const { data: { session } } = await supabase.auth.getSession();
        if (session) {
            currentUser = session.user;
            await loadProfile();
        } else {
            // 检查URL是否有邀请码
            const params = new URLSearchParams(window.location.search);
            const refCode = params.get('ref');
            if (refCode) {
                localStorage.setItem('cf_invited_by', refCode);
            }
        }
        updateUI();
        
        // 检查是否是支付回调
        checkPaymentCallback();
    });

    function updateUI() {
        if (currentUser) {
            document.getElementById('btnLogin').classList.add('hidden');
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('creditCount').innerText = userProfile?.credits || 0;
            document.getElementById('profileCredits').innerText = userProfile?.credits || 0;
            document.getElementById('profileEmail').innerText = currentUser.email;
            document.getElementById('profileCode').innerText = userProfile?.invite_code || '--';
            
            // 生成推广链接
            const link = `${window.location.origin}${window.location.pathname}?ref=${userProfile?.invite_code}`;
            document.getElementById('shareLinkInput').value = link;
        } else {
            document.getElementById('btnLogin').classList.remove('hidden');
            document.getElementById('userInfo').classList.add('hidden');
        }
    }

    async function loadProfile() {
        const { data, error } = await supabase
            .from('profiles')
            .select('*')
            .eq('id', currentUser.id)
            .single();
        
        if (data) {
            userProfile = data;
            updateUI();
        }
    }

    // --- 3. 认证逻辑 ---
    async function handleRegister() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;
        
        // 获取邀请人
        const invitedBy = localStorage.getItem('cf_invited_by');

        const { data, error } = await supabase.auth.signUp({
            email: email,
            password: password,
        });

        if (error) {
            alert("注册失败：" + error.message);
        } else {
            alert("注册成功！已赠送 1 次测算机会。");
            
            // 手动更新 invited_by (如果 trigger 没处理好，这里补救)
            if (invitedBy && data.user) {
                await supabase.from('profiles').update({ invited_by: invitedBy }).eq('id', data.user.id);
            }
            
            closeModal('authModal');
            location.reload();
        }
    }

    async function handleLogin() {
        const email = document.getElementById('emailInput').value;
        const password = document.getElementById('passwordInput').value;

        const { data, error } = await supabase.auth.signInWithPassword({
            email: email,
            password: password,
        });

        if (error) {
            alert("登录失败：" + error.message);
        } else {
            closeModal('authModal');
            location.reload();
        }
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        location.reload();
    }

    // --- 4. 核心测算逻辑 ---
    async function checkCreditsAndStart() {
        const input = document.getElementById('questionInput').value.trim();
        if (input.length < 2) {
            alert("请输入问题");
            return;
        }

        if (!currentUser) {
            alert("请先登录，新用户注册即送免费次数！");
            showAuthModal();
            return;
        }

        if (userProfile.credits > 0) {
            // 扣除积分
            const newCredits = userProfile.credits - 1;
            const { error } = await supabase
                .from('profiles')
                .update({ credits: newCredits })
                .eq('id', currentUser.id);
            
            if (!error) {
                userProfile.credits = newCredits;
                updateUI();
                startAnalysisFlow(input); // 开始测算
            } else {
                alert("网络错误，扣费失败");
            }
        } else {
            // 余额不足
            document.getElementById('creditModal').classList.remove('hidden');
        }
    }

    // --- 5. 支付与裂变逻辑 ---
    function startPayment() {
        // 记录当前用户ID，用于回调时加分
        const tradeNo = new Date().getTime() + Math.floor(Math.random() * 1000);
        
        // 构造支付参数
        const payData = {
            pid: CONFIG.paymentId,
            money: "1.88", // 固定价格
            name: "春风阁缘分值充值",
            notify_url: CONFIG.notifyUrl,
            out_trade_no: tradeNo,
            return_url: window.location.href.split('?')[0] + "?status=paid&uid=" + currentUser.id, // 带上uid
            sitename: "春风阁",
            type: "alipay"
        };

        const sortedParams = Object.keys(payData).sort().map(k => `${k}=${payData[k]}`).join('&');
        const sign = md5(sortedParams + CONFIG.paymentKey);
        
        // 表单提交
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = CONFIG.submitUrl;
        form.target = '_self';
        
        Object.keys(payData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = payData[key];
            form.appendChild(input);
        });
        
        const signInput = document.createElement('input');
        signInput.type = 'hidden';
        signInput.name = 'sign';
        signInput.value = sign;
        form.appendChild(signInput);
        
        const typeInput = document.createElement('input');
        typeInput.type = 'hidden';
        typeInput.name = 'sign_type';
        typeInput.value = 'MD5';
        form.appendChild(typeInput);

        document.body.appendChild(form);
        form.submit();
    }

    async function checkPaymentCallback() {
        const params = new URLSearchParams(window.location.search);
        const status = params.get('status');
        const uid = params.get('uid');

        // 简单的防刷：只有本人才能处理自己的回调
        if (status === 'paid' && currentUser && uid === currentUser.id) {
            // 1. 给自己加 1 分
            // 注意：这里为了防刷，最好是在后端处理。但在纯前端模式下，我们利用LocalStorage做简单的去重
            const lastTx = localStorage.getItem('last_tx');
            const now = new Date().getTime();
            if (lastTx && (now - lastTx < 5000)) return; // 5秒内不重复处理
            localStorage.setItem('last_tx', now);

            // 获取最新数据
            const { data: profile } = await supabase.from('profiles').select('*').eq('id', currentUser.id).single();
            
            // 增加积分
            await supabase.from('profiles').update({ credits: profile.credits + 1 }).eq('id', currentUser.id);
            
            // 2. 检查是否有邀请人，如果有，给邀请人加 2 分
            if (profile.invited_by) {
                // 查找邀请人的ID
                const { data: inviter } = await supabase.from('profiles').select('id, credits').eq('invite_code', profile.invited_by).single();
                if (inviter) {
                    await supabase.from('profiles').update({ credits: inviter.credits + 2 }).eq('id', inviter.id);
                }
            }

            alert("充值成功！缘分值 +1");
            window.location.href = window.location.pathname; // 清除URL参数
        }
    }

    // --- 6. AI 测算部分 (之前的功能) ---
    async function startAnalysisFlow(question) {
        document.getElementById("inputSection").classList.add("hidden");
        document.getElementById("loadingState").classList.remove("hidden");
        
        // 计算时间
        const now = new Date();
        const solar = Solar.fromDate(now);
        const lunar = solar.getLunar();
        const lunarStr = `农历${lunar.getMonthInChinese()}月${lunar.getDayInChinese()}`;
        const hour = now.getHours();
        const shichenIdx = Math.floor((hour + 1) / 2) % 12;
        
        // 小六壬算法
        const m = Math.abs(lunar.getMonth());
        const d = lunar.getDay();
        const t = shichenIdx + 1;
        const s1 = (m - 1) % 9;
        const s2 = (s1 + d - 1) % 9;
        const s3 = (s2 + t - 1) % 9;
        const NINE_GODS = ["大安","留连","速喜","赤口","小吉","空亡","病符","桃花","天德"];
        const gods = [NINE_GODS[s1], NINE_GODS[s2], NINE_GODS[s3]];

        // 调用AI
        const prompt = `用户问：${question}。卦象：${gods.join('->')}。请以道家高人身份，给出300字左右的详细批注，包含：直断吉凶、当下分析、未来建议。语气要温暖、坚定、通俗。使用HTML标签排版。`;

        try {
            const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${CONFIG.apiToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "deepseek-ai/DeepSeek-V3",
                    messages: [{role: "user", content: prompt}],
                    temperature: 0.7
                })
            });
            const data = await response.json();
            const content = data.choices[0].message.content;

            document.getElementById("loadingState").classList.add("hidden");
            document.getElementById("resultSection").classList.remove("hidden");
            
            document.getElementById("god1").innerText = gods[0];
            document.getElementById("god2").innerText = gods[1];
            document.getElementById("god3").innerText = gods[2];
            document.getElementById("aiContent").innerHTML = content;

        } catch (e) {
            alert("天机连接失败，请重试");
            location.reload();
        }
    }

    // 辅助函数
    function showAuthModal() { document.getElementById('authModal').classList.remove('hidden'); }
    function showProfileModal() { document.getElementById('profileModal').classList.remove('hidden'); }
    function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
    function copyShareLink() {
        const link = document.getElementById('shareLinkInput');
        link.select();
        document.execCommand("copy");
        alert("推广链接已复制！发给朋友吧~");
    }
  </script>
</body>
</html>
