<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>春风阁 - 道家秘传九神版</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" />
  <!-- 引入专业农历库 -->
  <script src="https://cdn.jsdelivr.net/npm/lunar-javascript@1.2.37/lunar.min.js"></script>
  <!-- 引入 MD5 -->
  <script src="https://cdn.bootcdn.net/ajax/libs/blueimp-md5/2.16.0/js/md5.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#E0C38C", // 杏仁金
            secondary: "#10B981", // 春风绿
            darkbg: "#0C1816", // 极深墨绿背景
            paper: "#152623", // 卡片背景
            accent: "#1677FF", // 支付宝蓝
          },
          fontFamily: {
            serif: ["Noto Serif SC", "STSong", "SimSun", "serif"],
            sans: ["PingFang SC", "Microsoft YaHei", "sans-serif"],
          },
          animation: {
            "fade-in": "fadeIn 1s ease-in-out",
            "slide-up": "slideUp 0.8s ease-out",
            "pulse-slow": "pulse 3s ease-in-out infinite",
            "float": "float 3s ease-in-out infinite",
            "scroll-left": "scrollLeft 50s linear infinite",
          },
          keyframes: {
            scrollLeft: {
              '0%': { transform: 'translateX(0)' },
              '100%': { transform: 'translateX(-50%)' },
            }
          }
        },
      },
    };
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
        .text-gold { color: #E0C38C; text-shadow: 0 0 10px rgba(224, 195, 140, 0.2); }
        .bg-gradient-chunfeng { background: radial-gradient(circle at center, #134e4a 0%, #042f2e 50%, #000000 100%); }
        .card-glass { background: rgba(20, 50, 45, 0.4); backdrop-filter: blur(10px); border: 1px solid rgba(224, 195, 140, 0.15); box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1); }
        .blur-lock { filter: blur(6px); user-select: none; pointer-events: none; }
        .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(12, 24, 22, 0.8) 40%, rgba(12, 24, 22, 1) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; }
    }
    @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    body { background-color: #0C1816; color: #e5e5e5; font-family: 'STSong', 'Noto Serif SC', serif; }
    .bagua-spinner { width: 60px; height: 60px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRTBDMzhDIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNTAgMiBBNDggNDggMCAwIDEgNTAgOTggQTQ4IDQ4IDAgMCAwIDUwIDIgWiIgZmlsbD0iI0UwQzM4QyIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMjYiIHI9IjYiIGZpbGw9IiMwMDAiLz48Y2lyY2xlIGN4PSI1MCIgY3k9Ijc0IiByPSI2IiBmaWxsPSIjRTBDMzhDIi8+PC9zdmc+'); animation: spin 2s linear infinite; margin: 0 auto; }
  </style>
</head>

<body class="bg-gradient-chunfeng min-h-screen font-serif text-gray-200">

  <!-- 顶部导航 -->
  <div class="fixed top-0 w-full z-50 bg-[#0C1816]/70 backdrop-blur-md border-b border-white/5">
    <div class="max-w-md mx-auto px-4 h-12 flex items-center justify-between">
      <div class="flex items-center">
        <i class="fa fa-leaf text-secondary mr-2" aria-hidden="true"></i>
        <span class="font-bold text-gold tracking-widest text-lg">春风阁</span>
      </div>
      <div class="text-xs text-gray-400 font-sans tracking-wide">道家秘传 · 九神推衍</div>
    </div>
  </div>

  <!-- 主容器 -->
  <div class="max-w-md mx-auto pt-20 pb-24 px-4 relative">
    
    <!-- 头部标语 -->
    <div class="text-center mb-10 animate-fade-in">
      <h1 class="text-4xl font-bold text-gold mb-3 tracking-[0.2em]" style="text-shadow: 0 4px 10px rgba(0,0,0,0.6);">
        问春风
      </h1>
      <p class="text-gray-400 text-sm font-sans opacity-80 tracking-widest">
        道家秘传九神版 · 探寻命理玄机
      </p>
    </div>

    <!-- 实时日期展示 -->
    <div class="card-glass rounded-xl p-4 mb-8 text-center border-t border-white/10">
        <div class="flex justify-between items-center text-sm font-sans">
            <div class="text-gray-400 text-left">
                <div class="mb-1 text-xs opacity-60">阳历</div>
                <div id="solarDate" class="text-gray-200 font-bold tracking-wide"></div>
            </div>
            <div class="w-px h-8 bg-white/10"></div>
            <div class="text-secondary text-right">
                <div class="mb-1 text-xs opacity-80">农历 / 时辰</div>
                <div id="lunarDate" class="font-bold tracking-wide"></div>
            </div>
        </div>
    </div>

    <!-- 核心输入区 -->
    <div id="inputSection" class="relative z-20">
      <div class="card-glass rounded-2xl p-6 shadow-2xl animate-slide-up border border-secondary/20">
        <div class="flex items-center mb-4">
            <div class="w-1 h-5 bg-secondary mr-3 rounded-full"></div>
            <h3 class="text-lg font-bold text-gray-100">请写下心中困惑</h3>
        </div>
        <textarea id="questionInput" 
          placeholder="例如：
• 这一份工作该不该换？
• 那个TA是不是我的正缘？
• 最近财运有些低迷，如何化解？
• 下个月准备创业，时机对吗？

(心中默念三遍，诚心发问)"
          class="w-full h-36 bg-[#08100F]/60 border border-white/10 rounded-xl p-4 text-gray-200 focus:border-secondary/50 focus:ring-1 focus:ring-secondary/50 outline-none transition-all placeholder-gray-600 font-sans text-base resize-none"></textarea>
        
        <div class="mt-6">
            <button onclick="startAnalysisFlow()"
              class="w-full bg-gradient-to-r from-emerald-800 via-teal-700 to-emerald-900 hover:from-emerald-700 hover:to-emerald-800 text-white font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center group border border-white/5">
              <span class="text-lg tracking-[0.2em] group-hover:animate-pulse">春风指路</span>
              <i class="fa fa-angle-right ml-2 group-hover:translate-x-1 transition-transform"></i>
            </button>
            <p class="text-center text-xs text-gray-500 mt-4 font-sans flex justify-center items-center">
                <span class="w-1.5 h-1.5 bg-secondary rounded-full mr-2 animate-pulse"></span>
                今日已有 <span class="text-gold font-bold mx-1" id="visitorCount">1,208</span> 人解开心中结
            </p>
        </div>
      </div>
    </div>

    <!-- 加载中动画 -->
    <div id="loadingState" class="hidden py-12 text-center">
        <div class="bagua-spinner mb-6"></div>
        <p class="text-gold text-xl mb-2 font-serif tracking-widest">春风拂面 天机渐显</p>
        <p class="text-gray-500 text-sm font-sans animate-pulse" id="loadingText">正在沟通时空能量...</p>
    </div>

    <!-- 结果展示区 -->
    <div id="resultSection" class="hidden animate-fade-in">
        
        <!-- 免费：卦象展示 (Teaser) -->
        <div class="card-glass rounded-xl p-5 mb-4 border border-secondary/20">
            <div class="text-center mb-5">
                <span class="bg-secondary/10 text-secondary px-4 py-1.5 rounded-full text-xs border border-secondary/20 tracking-wider">当前时空卦象</span>
            </div>
            
            <div class="grid grid-cols-3 gap-3 mb-5 text-center">
                <div class="bg-[#08100F]/50 p-3 rounded-lg border border-white/5">
                    <div class="text-xs text-gray-500 mb-1">初象(月)</div>
                    <div class="text-xl font-bold text-gray-200" id="teaserGod1">--</div>
                </div>
                <div class="bg-[#08100F]/50 p-3 rounded-lg border border-white/5">
                    <div class="text-xs text-gray-500 mb-1">中象(日)</div>
                    <div class="text-xl font-bold text-gray-200" id="teaserGod2">--</div>
                </div>
                <div class="bg-[#08100F]/50 p-3 rounded-lg border border-white/5">
                    <div class="text-xs text-gray-500 mb-1">末象(时)</div>
                    <div class="text-xl font-bold text-gray-200" id="teaserGod3">--</div>
                </div>
            </div>
            
            <div class="text-center pb-2">
                <p class="text-gray-400 text-sm mb-2">卦意总断：</p>
                <p class="text-xl text-white font-bold tracking-widest" id="teaserVerdict">--</p>
            </div>
        </div>

        <!-- 付费墙区域 -->
        <div id="payWall" class="relative overflow-hidden rounded-2xl border border-secondary/30 shadow-[0_0_30px_rgba(16,185,129,0.1)]">
            <div class="bg-paper p-8 blur-lock opacity-60">
                <h3 class="font-bold text-xl mb-4 text-secondary">大师详细批注</h3>
                <p class="mb-4">根据您的卦象显示，目前正处于运势上升期。天德入命，主有贵人提携，在事业方面...</p>
                <p class="mb-4">感情方面，桃花星动，但也伴随着一些不确定因素。需要注意的流月是...</p>
                <h4 class="font-bold text-lg mb-2">未来三月运势预测</h4>
                <div class="h-4 bg-gray-600 rounded mb-2 w-3/4"></div>
                <div class="h-4 bg-gray-600 rounded mb-2 w-full"></div>
                <div class="h-4 bg-gray-600 rounded mb-2 w-5/6"></div>
                <h4 class="font-bold text-lg mb-2 mt-4">大师锦囊妙计</h4>
                <div class="h-24 bg-gray-600 rounded"></div>
            </div>

            <div class="lock-overlay p-6 text-center">
                <div class="w-16 h-16 bg-gradient-to-br from-emerald-500 to-teal-700 rounded-full flex items-center justify-center mb-4 shadow-lg animate-float">
                    <i class="fa fa-lock text-2xl text-white"></i>
                </div>
                <h3 class="text-2xl font-bold text-white mb-2 tracking-wide">解锁完整天机报告</h3>
                <p class="text-gray-400 text-sm mb-8 max-w-xs leading-relaxed">包含：详细时运分析 + 未来趋势预测 + 春风避坑建议</p>
                
                <div class="bg-[#08100F]/80 rounded-lg p-4 mb-6 w-full max-w-xs backdrop-blur-sm border border-secondary/20">
                    <div class="flex justify-center items-end">
                        <span class="text-gray-500 text-sm mb-1 line-through mr-3">原价 ¥39.9</span>
                        <span class="text-4xl font-bold text-secondary mr-1" id="uiPriceDisplay">¥9.9</span>
                        <span class="text-gray-400 text-xs mb-1">/次</span>
                    </div>
                </div>

                <button onclick="startPayment()" 
                    class="w-full max-w-xs bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white font-bold py-4 rounded-xl shadow-lg transition-all flex items-center justify-center text-lg tracking-wider">
                    <i class="fa fa-shield mr-2"></i> 支付宝安全支付
                </button>
                <p class="text-xs text-gray-500 mt-4">支持支付宝 · 隐私严格保密</p>
            </div>
        </div>

        <!-- 真正的AI结果容器 -->
        <div id="aiRealResult" class="hidden">
            <div class="card-glass rounded-2xl p-6 animate-slide-up border border-secondary/30">
                <div class="flex items-center justify-between mb-6 pb-4 border-b border-white/10">
                    <h3 class="text-xl font-bold text-gold flex items-center">
                        <i class="fa fa-leaf mr-2 text-secondary"></i> 春风批注
                    </h3>
                    <span class="text-xs text-secondary bg-secondary/10 px-2 py-1 rounded border border-secondary/20">大师亲批</span>
                </div>
                <div id="analysisContent" class="prose prose-invert prose-gold max-w-none text-gray-300 leading-loose text-justify font-serif"></div>
                <div class="mt-8 flex space-x-3">
                    <button onclick="copyResult()" class="flex-1 bg-white/5 hover:bg-white/10 text-gray-300 py-3 rounded-lg text-sm transition-colors border border-white/10">
                        <i class="fa fa-copy mr-1"></i> 复制结果
                    </button>
                    <button onclick="location.href=location.pathname" class="flex-1 bg-secondary/20 hover:bg-secondary/30 text-secondary py-3 rounded-lg text-sm transition-colors border border-secondary/30">
                        <i class="fa fa-refresh mr-1"></i> 再测一事
                    </button>
                </div>
            </div>
            <div class="mt-6 text-center">
                <p class="text-xs text-gray-500 opacity-60">*命由天定，运由己生。结果仅供参考，切勿迷信。</p>
            </div>
        </div>
    </div>
    
    <!-- 底部滚动好评 -->
    <div class="fixed bottom-0 left-0 right-0 bg-[#0C1816]/90 backdrop-blur border-t border-white/5 py-2 z-40" id="socialProof">
        <div class="relative w-full overflow-hidden h-6">
            <div id="marqueeContent" class="absolute whitespace-nowrap animate-scroll-left text-xs text-gray-400 font-sans flex items-center space-x-12 px-4">
                <!-- 内容将由JS动态生成 -->
            </div>
        </div>
    </div>
  </div>

  <script>
    // --- 【核心配置】 ---
    const CONFIG = {
        defaultPrice: "9.9", 
        discountPrice: "1.88",  
        magicCode: "xiaoliuren.xyz", 
        freeCode: "chunfeng", 
        apiToken: "sk-zhkdhbaohshweaxxzxlvvucvklmlwsepbzmmghkxxkrfwpli", 
        paymentId: "2025111020404744", 
        paymentKey: "6Ecg3jrd3W4jcOADKclHaU0N5AsWftbB", 
        notifyUrl: "http://www.xiaoliuren.xyz", 
        submitUrl: "https://z-pay.cn/submit.php"
    };

    const NINE_GODS = [
      { name: "大安", type: "吉" }, { name: "留连", type: "平" }, { name: "速喜", type: "吉" },
      { name: "赤口", type: "凶" }, { name: "小吉", type: "吉" }, { name: "空亡", type: "凶" },
      { name: "病符", type: "凶" }, { name: "桃花", type: "平" }, { name: "天德", type: "吉" }
    ];
    const SHICHEN = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];

    let currentStages = []; 
    let userQuestion = "";  

    document.addEventListener("DOMContentLoaded", function () {
      updateTimeDisplay();
      setInterval(updateTimeDisplay, 1000); 
      generateDailyVisitorCount();
      generateRealisticMarquee();
      checkPaymentResult();
    });

    // --- 1. 每日动态人数 ---
    function generateDailyVisitorCount() {
        const now = new Date();
        const seed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const baseCount = 1050 + (dayOfYear * 15); 
        const dynamicPart = now.getHours() * 8 + now.getMinutes(); 
        const finalCount = baseCount + dynamicPart;
        document.getElementById("visitorCount").innerText = finalCount.toLocaleString();
    }

    // --- 2. 真实感无限滚动弹幕 ---
    function generateRealisticMarquee() {
        const actions = ["解锁了 事业运势报告", "查看了 感情复合分析", "咨询了 财运走向", "解锁了 每日吉凶", "查看了 婚姻匹配度", "咨询了 跳槽建议", "解锁了 健康运势"];
        const times = ["刚刚", "1分钟前", "2分钟前", "刚刚", "3分钟前", "5分钟前"];
        let contentHtml = "";
        
        function getRandomId() {
            const start = Math.floor(Math.random() * 9 + 1); 
            const end = Math.random() > 0.5 ? Math.floor(Math.random() * 10) : String.fromCharCode(97 + Math.floor(Math.random() * 6)); 
            return `${start}***${end}`;
        }

        for (let i = 0; i < 20; i++) {
            const userId = getRandomId();
            const action = actions[Math.floor(Math.random() * actions.length)];
            const time = times[Math.floor(Math.random() * times.length)];
            contentHtml += `
                <span class="flex items-center">
                    <span class="text-gray-500 mr-2">[${time}]</span>
                    <span class="text-gray-400">支付宝用户 ${userId}</span>
                    <span class="text-secondary ml-1 opacity-80">${action}</span>
                </span>
            `;
        }
        
        const marqueeEl = document.getElementById("marqueeContent");
        marqueeEl.innerHTML = contentHtml + contentHtml;
    }

    // --- 3. 时间与起卦 ---
    function updateTimeDisplay() {
        const now = new Date();
        const solar = Solar.fromDate(now);
        const lunar = solar.getLunar();
        
        const solarStr = `${solar.getYear()}年${solar.getMonth()}月${solar.getDay()}日`;
        document.getElementById("solarDate").innerText = solarStr;
        
        const lunarMonth = lunar.getMonth(); 
        const lunarDay = lunar.getDay();     
        const hour = now.getHours();
        
        let shichenIdx = Math.floor((hour + 1) / 2) % 12;
        const shichenName = SHICHEN[shichenIdx] + "时";
        
        const lunarStr = `农历${lunar.getMonthInChinese()}月${lunar.getDayInChinese()} ${shichenName}`;
        document.getElementById("lunarDate").innerText = lunarStr;
        
        const m = Math.abs(lunarMonth); 
        const d = lunarDay;
        const t = shichenIdx + 1; 
        
        const s1 = (m - 1) % 9;
        const s2 = (s1 + d - 1) % 9;
        const s3 = (s2 + t - 1) % 9;
        
        currentStages = [NINE_GODS[s1], NINE_GODS[s2], NINE_GODS[s3]];
    }

    // --- 4. 交互流程 ---
    function startAnalysisFlow() {
        let rawInput = document.getElementById("questionInput").value.trim();
        if (rawInput.length < 2) {
            alert("请诚心输入您想测算的问题");
            return;
        }

        // === 免费通道 ===
        if (rawInput.toLowerCase().includes(CONFIG.freeCode.toLowerCase())) {
            userQuestion = rawInput.replace(new RegExp(CONFIG.freeCode, "gi"), "").trim();
            if(!userQuestion) userQuestion = "综合运势详解";
            
            document.getElementById("inputSection").classList.add("hidden");
            document.getElementById("loadingState").classList.remove("hidden");
            document.getElementById("socialProof").classList.add("hidden");
            
            setTimeout(() => {
                document.getElementById("loadingState").classList.add("hidden");
                document.getElementById("resultSection").classList.remove("hidden");
                document.getElementById("payWall").classList.add("hidden"); 
                document.getElementById("aiRealResult").classList.remove("hidden"); 
                
                showTeaserResult(false); 
                
                document.getElementById("analysisContent").innerHTML = `
                    <div class="text-center py-10">
                         <div class="bagua-spinner mb-4"></div>
                         <p class="text-gold">春风阁大师正在为您批注...</p>
                         <p class="text-xs text-gray-500 mt-2">VIP通道已激活，正在解析${currentStages[0].name}-${currentStages[1].name}-${currentStages[2].name}</p>
                    </div>
                `;
                callAI();
            }, 2000);
            return;
        }

        // === 正常/优惠通道 ===
        userQuestion = rawInput;
        document.getElementById("inputSection").classList.add("hidden");
        document.getElementById("loadingState").classList.remove("hidden");
        document.getElementById("socialProof").classList.add("hidden"); 

        const loadingTexts = ["正在沟通天地...", "正在排盘...", "正在连接时空能量...", "卦象已成..."];
        let step = 0;
        const timer = setInterval(() => {
            if(step < loadingTexts.length) {
                document.getElementById("loadingText").innerText = loadingTexts[step];
                step++;
            }
        }, 600);

        setTimeout(() => {
            clearInterval(timer);
            showTeaserResult(true); 
        }, 2800);
    }

    function showTeaserResult(showPayWall) {
        if(showPayWall) {
            document.getElementById("loadingState").classList.add("hidden");
            document.getElementById("resultSection").classList.remove("hidden");
            
            // --- 动态价格UI更新逻辑 ---
            if (userQuestion.toLowerCase().includes(CONFIG.magicCode.toLowerCase())) {
                 document.getElementById("uiPriceDisplay").innerText = "¥" + CONFIG.discountPrice;
            } else {
                 document.getElementById("uiPriceDisplay").innerText = "¥" + CONFIG.defaultPrice;
            }
        }
        
        if(!currentStages || currentStages.length === 0) {
            updateTimeDisplay();
        }
        
        document.getElementById("teaserGod1").innerText = currentStages[0].name;
        document.getElementById("teaserGod2").innerText = currentStages[1].name;
        document.getElementById("teaserGod3").innerText = currentStages[2].name;
        
        let goodCount = currentStages.filter(g => g.type === '吉').length;
        let badCount = currentStages.filter(g => g.type === '凶').length;
        let verdict = "平稳之象，待机而动";
        if (goodCount >= 2) verdict = "上吉之卦，贵人引路";
        if (badCount >= 2) verdict = "前途多艰，需慎重行事";
        if (currentStages[2].name === '速喜') verdict = "心念之事，立见分晓";
        
        const verdictEl = document.getElementById("teaserVerdict");
        verdictEl.innerText = verdict;
        verdictEl.className = goodCount >= 2 ? "text-xl text-secondary font-bold tracking-widest" : "text-xl text-white font-bold tracking-widest";
    }

    // --- 5. 支付逻辑 (修复版：纯表单提交，最稳定唤起支付宝) ---
    function startPayment() {
        let finalPrice = CONFIG.defaultPrice; 
        let finalQuestion = userQuestion;

        if (userQuestion.toLowerCase().includes(CONFIG.magicCode.toLowerCase())) {
            finalPrice = CONFIG.discountPrice; 
            finalQuestion = userQuestion.replace(new RegExp(CONFIG.magicCode, "gi"), "").trim();
            if(finalQuestion.length === 0) finalQuestion = "综合运势分析"; 
        }

        // 存入本地，防止跳转丢失
        localStorage.setItem('cf_question', finalQuestion);
        localStorage.setItem('cf_timestamp', new Date().getTime());

        const baseUrl = window.location.href.split('?')[0];
        const returnUrl = `${baseUrl}?status=paid`; 

        const payData = {
            pid: CONFIG.paymentId,
            money: finalPrice, 
            name: "春风阁VIP深度测算报告",
            notify_url: CONFIG.notifyUrl,
            out_trade_no: new Date().getTime() + Math.floor(Math.random() * 1000),
            return_url: returnUrl,
            sitename: "春风阁",
            type: "alipay" 
        };

        // 计算签名
        const sortedParams = Object.keys(payData).sort().map(k => `${k}=${payData[k]}`).join('&');
        const paySign = md5(sortedParams + CONFIG.paymentKey);
        payData.sign = paySign;
        payData.sign_type = "MD5";

        // 创建隐形表单并提交 (最稳的跳转方式)
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = CONFIG.submitUrl;
        form.target = '_self'; 
        
        Object.keys(payData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = payData[key];
            form.appendChild(input);
        });
        
        document.body.appendChild(form);
        form.submit();
    }

    // --- 6. 回调与AI (LocalStorage + 修复 Teaser不显示问题) ---
    function checkPaymentResult() {
        const params = new URLSearchParams(window.location.search);
        const status = params.get('status');

        if (status === 'paid') {
            const storedQuestion = localStorage.getItem('cf_question');
            
            if (storedQuestion) {
                userQuestion = storedQuestion;
                
                document.getElementById("inputSection").classList.add("hidden");
                document.getElementById("resultSection").classList.remove("hidden");
                document.getElementById("payWall").classList.add("hidden");
                document.getElementById("aiRealResult").classList.remove("hidden");
                
                updateTimeDisplay();
                showTeaserResult(false);

                document.getElementById("analysisContent").innerHTML = `
                    <div class="text-center py-10">
                        <div class="bagua-spinner mb-4"></div>
                        <p class="text-gold">春风阁大师正在为您批注...</p>
                        <p class="text-xs text-gray-500 mt-2">正在深度解析${currentStages[0].name}-${currentStages[1].name}-${currentStages[2].name}卦象</p>
                    </div>
                `;
                
                callAI();
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }
    }

    async function callAI() {
        updateTimeDisplay(); 
        const lunarDate = document.getElementById("lunarDate").innerText;
        
        const prompt = `
        你是一位精通周易、小六壬、奇门遁甲的世外高人（号“春风道人”）。用户刚刚支付了润金，请求你为其指点迷津。
        
        用户信息：
        - 提问：${userQuestion}
        - 卦象：${currentStages[0].name} -> ${currentStages[1].name} -> ${currentStages[2].name}
        - 时间：${lunarDate}

        请输出一份详尽的《春风阁天机批注》，语气要庄重、神秘、文雅但充满慈悲（多用“缘主”称呼）。
        
        报告结构必须包含HTML标签（使用 <h4>, <p>, <ul>, <li>, <strong>），结构如下：
        
        1. <h4>【春风解卦】</h4>
           <p>解释这三个神煞组合的深层含义，针对用户问题进行定性（吉/凶/平）。</p>
           
        2. <h4>【时运详解】</h4>
           <p>详细分析用户现状和未来趋势。至少300字，内容要具体，不要说套话。</p>
           
        3. <h4>【前路预警】</h4>
           <p>根据“${currentStages[2].name}”这个末宫，预测未来可能遇到的具体障碍或转折点。</p>
           
        4. <h4>【锦囊妙计】</h4>
           <ul>
             <li>给出3条具体的建议（如：有利方位、幸运颜色、行事风格、贵人生肖等）。</li>
           </ul>
           
        5. <p style="text-align:center; color:#10B981; margin-top:20px;"><i>遇事不明，可问春风。愿缘主顺遂。</i></p>
        
        请直接输出HTML内容，不要包裹Markdown代码块。
        `;

        try {
            const response = await fetch("https://api.siliconflow.cn/v1/chat/completions", {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${CONFIG.apiToken}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    model: "deepseek-ai/DeepSeek-V3",
                    messages: [
                        {role: "system", content: "你是一位精通中国传统术数的老道长，擅长小六壬。"},
                        {role: "user", content: prompt}
                    ],
                    temperature: 0.7,
                    max_tokens: 2000
                })
            });
            
            const data = await response.json();
            if (data.choices && data.choices[0]) {
                const content = data.choices[0].message.content;
                document.getElementById("analysisContent").innerHTML = content;
            } else {
                throw new Error("API Error");
            }

        } catch (e) {
            document.getElementById("analysisContent").innerHTML = `
                <h4>【春风解卦】</h4>
                <p>缘主安好。今日云游太虚，信号稍显微弱。但观卦象，${currentStages[0].name}起首，主基业平稳。</p>
                <p>针对您所问之事“${userQuestion}”，目前时机尚可。${currentStages[2].name}临门，建议守正待时。</p>
                <p>建议稍后刷新页面，或者保存此结果，凡事向南而行，必有回响。</p>
            `;
        }
    }

    function copyResult() {
        const content = document.getElementById("analysisContent").innerText;
        const tempInput = document.createElement("textarea");
        tempInput.value = content;
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert("批注已复制，可粘贴保存");
    }
  </script>
</body>
</html>
