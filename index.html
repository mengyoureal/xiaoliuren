<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>春风阁 - 道家秘传九神版</title>
  
  <!-- 【核心修复】换回官方最稳定的 Tailwind 脚本，确保样式 100% 能加载 -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- 使用字节跳动(ByteDance)的超快国内源加载图标库 -->
  <link href="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" rel="stylesheet" />
  
  <!-- 使用字节跳动源加载农历库 -->
  <script src="https://lf26-cdn-tos.bytecdntp.com/cdn/expire-1-M/lunar-javascript/1.2.0/lunar.min.js"></script>
  
  <!-- 使用字节跳动源加载 MD5 -->
  <script src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/blueimp-md5/2.19.0/js/md5.min.js"></script>

  <!-- 预先定义加载样式，防止网页裸奔 -->
  <style>
    body { opacity: 0; transition: opacity 0.5s; background-color: #020617; } 
    /* 页面加载完才显示 */
    body.loaded { opacity: 1; }
  </style>

  <script>
    // 页面加载完成后显示，避免看到丑陋的排版
    window.onload = function() { document.body.classList.add('loaded'); }

    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: "#FCD34D", // 琥珀金
            secondary: "#D8B4FE", // 薰衣草紫
            accent: "#1677FF", // 支付宝蓝
            bgStart: "#2E1065", // 深紫
            bgEnd: "#020617",   // 墨蓝黑
          },
          fontFamily: {
            serif: ["Noto Serif SC", "STSong", "SimSun", "serif"],
            sans: ["PingFang SC", "Microsoft YaHei", "sans-serif"],
          },
          animation: {
            "fade-in": "fadeIn 1s ease-in-out",
            "slide-up": "slideUp 0.8s ease-out",
            "pulse-slow": "pulse 3s ease-in-out infinite",
            "float": "float 3s ease-in-out infinite",
            "scroll-left": "scrollLeft 60s linear infinite",
          },
          keyframes: {
            scrollLeft: {
              '0%': { transform: 'translateX(0)' },
              '100%': { transform: 'translateX(-50%)' },
            }
          }
        },
      },
    };
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
        .text-gold { color: #FCD34D; text-shadow: 0 0 8px rgba(252, 211, 77, 0.4); }
        .bg-mystic { background: radial-gradient(circle at top center, #3B0764 0%, #170526 60%, #000000 100%); }
        .card-glass { background: rgba(30, 20, 50, 0.4); backdrop-filter: blur(16px); border: 1px solid rgba(216, 180, 254, 0.15); box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4); }
        .blur-lock { filter: blur(12px); user-select: none; pointer-events: none; transition: filter 0.8s ease; }
        .blur-unlock { filter: blur(0); user-select: auto; pointer-events: auto; }
        .lock-overlay { position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(to bottom, rgba(10,5,20,0) 0%, rgba(10,5,20,0.95) 40%, rgba(10,5,20,1) 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; transition: opacity 0.5s ease; }
    }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    
    /* 字体兜底设置 */
    body { color: #E9D5FF; font-family: 'STSong', 'SimSun', 'Noto Serif SC', serif; }
    
    .bagua-spinner { width: 70px; height: 70px; background-image: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48Y2lyY2xlIGN4PSI1MCIgY3k9IjUwIiByPSI0OCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjRkREMzREIiBzdHJva2Utd2lkdGg9IjIiLz48cGF0aCBkPSJNNTAgMiBBNDggNDggMCAwIDEgNTAgOTggQTQ4IDQ4IDAgMCAwIDUwIDIgWiIgZmlsbD0iI0ZERDM0RCIvPjxjaXJjbGUgY3g9IjUwIiBjeT0iMjYiIHI9IjYiIGZpbGw9IiMzQjA3NjQiLz48Y2lyY2xlIGN4PSI1MCIgY3k9Ijc0IiByPSI2IiBmaWxsPSIjRkREMzREIi8+PC9zdmc+'); animation: spin 3s linear infinite; margin: 0 auto; }
  </style>
</head>

<body class="bg-mystic min-h-screen font-serif text-gray-200">

  <!-- 顶部导航 -->
  <div class="fixed top-0 w-full z-50 bg-[#170526]/80 backdrop-blur-md border-b border-purple-500/20">
    <div class="max-w-md mx-auto px-4 h-14 flex items-center justify-between">
      <div class="flex items-center">
        <span class="text-xl mr-2 text-gold">☯</span>
        <span class="font-bold text-gold tracking-widest text-lg">春风阁</span>
      </div>
      <div class="text-xs text-purple-300 font-sans tracking-wide opacity-80">道家秘传 · 紫微斗数</div>
    </div>
  </div>

  <!-- 主容器 -->
  <div class="max-w-md mx-auto pt-24 pb-24 px-4 relative">
    
    <!-- 头部标语 -->
    <div class="text-center mb-10 animate-fade-in">
      <h1 class="text-5xl font-bold text-gold mb-3 tracking-[0.2em]" style="text-shadow: 0 4px 20px rgba(147, 51, 234, 0.5);">
        问春风
      </h1>
      <p class="text-purple-200 text-sm font-sans opacity-90 tracking-[0.2em] uppercase">
        遇事不明 · 可问春风
      </p>
    </div>

    <!-- 实时日期展示 -->
    <div class="card-glass rounded-xl p-4 mb-8 text-center border-t border-purple-500/20">
        <div class="flex justify-between items-center text-sm font-sans text-purple-200">
            <div class="text-left opacity-90">
                <div class="text-xs mb-1 text-purple-400">阳历</div>
                <div id="solarDate" class="font-bold tracking-wide text-white"></div>
            </div>
            <div class="w-px h-8 bg-purple-500/30"></div>
            <div class="text-right opacity-90">
                <div class="text-xs mb-1 text-purple-400">农历 / 时辰</div>
                <div id="lunarDate" class="font-bold tracking-wide text-white"></div>
            </div>
        </div>
    </div>

    <!-- 核心输入区 -->
    <div id="inputSection" class="relative z-20">
      <div class="card-glass rounded-2xl p-6 shadow-2xl animate-slide-up">
        <div class="flex items-center mb-4">
            <div class="w-1 h-5 bg-gold mr-3 rounded-full shadow-[0_0_10px_#FCD34D]"></div>
            <h3 class="text-lg font-bold text-white tracking-wide">请诚心写下疑惑</h3>
        </div>
        <textarea id="questionInput" 
          placeholder="例如：
• 这一份工作该不该换？
• 那个TA是不是我的正缘？
• 最近财运有些低迷，如何化解？
• 下个月准备创业，时机对吗？

(心中默念三遍，诚心发问)"
          class="w-full h-36 bg-[#0F0518]/60 border border-purple-500/30 rounded-xl p-4 text-purple-100 focus:border-gold/60 focus:ring-1 focus:ring-gold/60 outline-none transition-all placeholder-purple-400/30 font-sans text-base resize-none"></textarea>
        
        <div class="mt-6">
            <button onclick="startAnalysisFlow()"
              class="w-full bg-gradient-to-r from-purple-900 via-purple-800 to-purple-900 hover:from-purple-800 hover:to-purple-700 text-gold font-bold py-4 rounded-xl shadow-[0_4px_20px_rgba(88,28,135,0.4)] border border-purple-500/30 active:scale-95 transition-all flex items-center justify-center group relative overflow-hidden">
              <div class="absolute inset-0 bg-gold/5 opacity-0 group-hover:opacity-20 transition-opacity"></div>
              <span class="text-lg tracking-[0.3em] group-hover:scale-105 transition-transform">排盘推演</span>
              <i class="fa fa-angle-right ml-2 group-hover:translate-x-1 transition-transform"></i>
            </button>
            <p class="text-center text-xs text-purple-400/60 mt-4 font-sans flex justify-center items-center">
                <span class="w-1.5 h-1.5 bg-green-400 rounded-full mr-2 animate-pulse"></span>
                今日已有 <span class="text-gold font-bold mx-1" id="visitorCount">1,208</span> 人获取指引
            </p>
        </div>
      </div>
    </div>

    <!-- 加载中动画 -->
    <div id="loadingState" class="hidden py-16 text-center">
        <div class="bagua-spinner mb-8"></div>
        <p class="text-gold text-2xl mb-3 font-serif tracking-widest">紫微斗数 天机推演</p>
        <p class="text-purple-300 text-sm font-sans animate-pulse tracking-wider opacity-80" id="loadingText">深度测算中，预计需要30秒...</p>
    </div>

    <!-- 结果展示区 -->
    <div id="resultSection" class="hidden animate-fade-in">
        
        <!-- 免费：卦象展示 + 现状分析 (长内容) -->
        <div class="card-glass rounded-xl p-5 mb-4">
            <!-- 卦象 -->
            <div class="text-center mb-6">
                <span class="bg-purple-900/40 text-gold px-6 py-1.5 rounded-full text-xs border border-purple-500/30 tracking-[0.2em] uppercase">当前时空卦象</span>
            </div>
            <div class="grid grid-cols-3 gap-3 mb-6 text-center">
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">初象(月)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod1">--</div>
                </div>
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">中象(日)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod2">--</div>
                </div>
                <div class="bg-black/30 p-3 rounded-lg border border-purple-500/20">
                    <div class="text-xs text-purple-400 mb-1 opacity-70">末象(时)</div>
                    <div class="text-xl font-bold text-white tracking-widest" id="teaserGod3">--</div>
                </div>
            </div>
            
            <!-- 卦意总断 -->
            <div class="text-center pb-4 border-b border-purple-500/10 mb-4">
                <p class="text-purple-300 text-xs mb-2 tracking-widest opacity-60">· 卦 意 总 断 ·</p>
                <p class="text-2xl text-gold font-bold tracking-widest font-serif" id="teaserVerdict">--</p>
            </div>
            
            <!-- 免费分析部分 (直白) -->
            <div class="mb-2">
                <div class="flex items-center mb-3 border-l-4 border-gold pl-3">
                    <h3 class="text-lg font-bold text-white tracking-wide">卦意批注</h3>
                </div>
                <div id="freeAnalysisContent" class="text-purple-100 text-[15px] leading-8 text-justify font-serif opacity-90 min-h-[120px]">
                    <!-- AI生成的免费部分 -->
                </div>
            </div>
        </div>

        <!-- 付费墙区域 (建议与锦囊) -->
        <div id="paidContentContainer" class="relative overflow-hidden rounded-2xl border border-purple-500/30 shadow-[0_0_40px_rgba(0,0,0,0.6)]">
            
            <!-- 内容层 (模糊) -->
            <div id="paidContentBlur" class="bg-white/5 p-8 blur-lock">
                <h3 class="font-bold text-xl mb-4 text-gold flex items-center border-l-4 border-gold pl-3">
                    大师锦囊
                </h3>
                <div id="paidAnalysisContent" class="text-purple-100 text-[15px] leading-relaxed opacity-80">
                    <!-- 占位符 -->
                    <p class="mb-4">根据卦象显示，您接下来需要特别注意的时间点是...</p>
                    <p class="mb-4">在行动方向上，建议向...</p>
                    <h4 class="font-bold text-lg mb-2 text-gold mt-6">避坑指南</h4>
                    <div class="h-4 bg-white/10 rounded mb-2 w-full"></div>
                    <div class="h-4 bg-white/10 rounded mb-2 w-5/6"></div>
                    <h4 class="font-bold text-lg mb-2 mt-4 text-gold">贵人指引</h4>
                    <div class="h-20 bg-white/10 rounded"></div>
                </div>
            </div>

            <!-- 遮罩层 (按钮) -->
            <div id="payOverlay" class="lock-overlay p-4 text-center">
                <div class="mb-6 animate-float">
                    <div class="w-14 h-14 bg-gradient-to-br from-purple-600 to-purple-900 rounded-full flex items-center justify-center mx-auto mb-3 shadow-[0_0_20px_rgba(147,51,234,0.5)] border border-gold/30">
                        <i class="fa fa-lock text-2xl text-gold"></i>
                    </div>
                    <h3 class="text-xl font-bold text-white mb-1 tracking-wide">解锁行动建议</h3>
                    <p class="text-purple-300 text-xs opacity-70">随喜润金 · 开启天机</p>
                </div>
                
                <!-- 价格按钮网格 -->
                <div class="grid grid-cols-2 gap-3 w-full mb-4 px-2">
                    <!-- 档位 1 -->
                    <button id="btn-tier-1" onclick="startPayment('1.68')" class="bg-black/60 border border-purple-500/30 hover:border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold" id="price-tier-1">¥ 1.68</span>
                        <span class="text-[10px] text-gray-400" id="label-tier-1">初探天机</span>
                    </button>
                    <!-- 档位 2 -->
                    <button onclick="startPayment('6.66')" class="bg-gradient-to-br from-purple-900 to-purple-800 border border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95 relative overflow-hidden shadow-lg">
                        <div class="absolute top-0 right-0 bg-[#FCD34D] text-purple-900 font-bold text-[9px] px-1.5 rounded-bl-lg">荐</div>
                        <span class="text-xl font-bold text-white">¥ 6.66</span>
                        <span class="text-[10px] text-gold/80">祈愿顺遂</span>
                    </button>
                    <!-- 档位 3 -->
                    <button onclick="startPayment('8.88')" class="bg-black/60 border border-purple-500/30 hover:border-gold/50 text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold">¥ 8.88</span>
                        <span class="text-[10px] text-gray-400">心诚则灵</span>
                    </button>
                    <!-- 档位 4 -->
                    <button onclick="startPayment('88.00')" class="bg-black/60 border border-gold/30 hover:border-gold text-white py-3 rounded-lg flex flex-col items-center justify-center transition-all active:scale-95">
                        <span class="text-lg font-bold text-gold">¥ 88.00</span>
                        <span class="text-[10px] text-gray-400">大德圆满</span>
                    </button>
                </div>
                
                <div class="flex items-center justify-center text-[10px] text-purple-400/50 mt-3">
                    <i class="fa fa-shield mr-1"></i>
                    <span>支持支付宝 · 隐私严格保密</span>
                </div>
            </div>
        </div>

        <!-- 结果操作按钮 -->
        <div id="resultActions" class="mt-6 flex space-x-3 hidden">
            <button onclick="copyResult()" class="flex-1 bg-white/5 hover:bg-white/10 text-purple-200 py-3 rounded-lg text-sm transition-colors border border-white/10">
                <i class="fa fa-copy mr-1"></i> 复制批注
            </button>
            <button onclick="location.href=location.pathname" class="flex-1 bg-gold/20 hover:bg-gold/30 text-gold py-3 rounded-lg text-sm transition-colors border border-gold/30">
                <i class="fa fa-refresh mr-1"></i> 再测一事
            </button>
        </div>
    </div>
    
    <!-- 底部滚动好评 -->
    <div class="fixed bottom-0 left-0 right-0 bg-[#0F0518]/90 backdrop-blur border-t border-purple-500/20 py-2 z-40" id="socialProof">
        <div class="relative w-full overflow-hidden h-6">
            <div id="marqueeContent" class="absolute whitespace-nowrap animate-scroll-left text-xs text-purple-300/60 font-sans flex items-center space-x-12 px-4">
                <!-- 内容将由JS动态生成 -->
            </div>
        </div>
    </div>
  </div>

  <script>
    // --- 【核心配置】 ---
    const CONFIG = {
        freeCode: "xiaoliuren.xyz", // 老板通道
        discountCode: "可问春风",   // 粉丝通道
        discountPrice: "1.00",      
        vipCodes: ["xiaoliuren.xyz", "可问春风"],
        
        apiToken: "sk-zhkdhbaohshweaxxzxlvvucvklmlwsepbzmmghkxxkrfwpli", 
        paymentId: "2025111020404744", 
        paymentKey: "6Ecg3jrd3W4jcOADKclHaU0N5AsWftbB", 
        notifyUrl: "http://www.xiaoliuren.xyz", 
        submitUrl: "https://z-pay.cn/submit.php"
    };

    const NINE_GODS = [
      { name: "大安", type: "吉" }, { name: "留连", type: "平" }, { name: "速喜", type: "吉" },
      { name: "赤口", type: "凶" }, { name: "小吉", type: "吉" }, { name: "空亡", type: "凶" },
      { name: "病符", type: "凶" }, { name: "桃花", type: "平" }, { name: "天德", type: "吉" }
    ];
    const SHICHEN = ["子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"];

    let currentStages = []; 
    let userQuestion = "";  

    document.addEventListener("DOMContentLoaded", function () {
      updateTimeDisplay();
      setInterval(updateTimeDisplay, 1000); 
      generateDailyVisitorCount();
      generateRealisticMarquee();
      checkPaymentResult();
    });

    // --- 1. 每日动态人数 ---
    function generateDailyVisitorCount() {
        const now = new Date();
        const seed = now.getFullYear() * 10000 + (now.getMonth() + 1) * 100 + now.getDate();
        const dayOfYear = Math.floor((now - new Date(now.getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
        const baseCount = 1050 + (dayOfYear * 15); 
        const dynamicPart = now.getHours() * 8 + now.getMinutes(); 
        const finalCount = baseCount + dynamicPart;
        document.getElementById("visitorCount").innerText = finalCount.toLocaleString();
    }

    // --- 2. 真实感无限滚动弹幕 ---
    function generateRealisticMarquee() {
        const actions = ["解锁了 事业运势报告", "查看了 感情复合分析", "咨询了 财运走向", "解锁了 每日吉凶", "查看了 婚姻匹配度", "咨询了 跳槽建议", "解锁了 健康运势"];
        const times = ["刚刚", "1分钟前", "2分钟前", "刚刚", "3分钟前", "5分钟前"];
        let contentHtml = "";
        
        function getRandomId() {
            const start = Math.floor(Math.random() * 9 + 1); 
            const end = Math.random() > 0.5 ? Math.floor(Math.random() * 10) : String.fromCharCode(97 + Math.floor(Math.random() * 6)); 
            return `${start}***${end}`;
        }

        for (let i = 0; i < 20; i++) {
            const userId = getRandomId();
            const action = actions[Math.floor(Math.random() * actions.length)];
            const time = times[Math.floor(Math.random() * times.length)];
            contentHtml += `
                <span class="flex items-center">
                    <span class="text-purple-400/50 mr-2">[${time}]</span>
                    <span class="text-purple-300/80">支付宝用户 ${userId}</span>
                    <span class="text-white ml-1 opacity-90">${action}</span>
                </span>
            `;
        }
        document.getElementById("marqueeContent").innerHTML = contentHtml + contentHtml;
    }

    // --- 3. 时间与起卦 ---
    function updateTimeDisplay() {
        const now = new Date();
        // 如果 lunar.js 加载失败，做个简单兜底
        if (typeof Solar === 'undefined') {
            document.getElementById("solarDate").innerText = "加载中...";
            return;
        }
        
        const solar = Solar.fromDate(now);
        const lunar = solar.getLunar();
        
        document.getElementById("solarDate").innerText = `${solar.getYear()}年${solar.getMonth()}月${solar.getDay()}日`;
        
        const lunarMonth = lunar.getMonth(); 
        const lunarDay = lunar.getDay();     
        const hour = now.getHours();
        let shichenIdx = Math.floor((hour + 1) / 2) % 12;
        const shichenName = SHICHEN[shichenIdx] + "时";
        
        document.getElementById("lunarDate").innerText = `农历${lunar.getMonthInChinese()}月${lunar.getDayInChinese()} ${shichenName}`;
        
        const m = Math.abs(lunarMonth); 
        const d = lunarDay;
        const t = shichenIdx + 1; 
        
        const s1 = (m - 1) % 9;
        const s2 = (s1 + d - 1) % 9;
        const s3 = (s2 + t - 1) % 9;
        
        currentStages = [NINE_GODS[s1], NINE_GODS[s2], NINE_GODS[s3]];
    }

    // --- 4. 交互流程 (强化版：真实等待 + 兜底) ---
    async function startAnalysisFlow() {
        let rawInput = document.getElementById("questionInput").value.trim();
        if (rawInput.length < 2) {
            alert("请诚心输入您想测算的问题");
            return;
        }

        // === 1. 老板通道 (Free) ===
        if (rawInput.toLowerCase().includes(CONFIG.freeCode.toLowerCase())) {
            userQuestion = rawInput.replace(new RegExp(CONFIG.freeCode, "gi"), "").trim();
            if(!userQuestion) userQuestion = "综合运势详解";
            await handleProcess(true);
            return;
        }

        // === 2. 正常/粉丝通道 (Need Pay) ===
        userQuestion = rawInput;
        await handleProcess(false);
    }

    async function handleProcess(isUnlocked) {
        document.getElementById("inputSection").classList.add("hidden");
        document.getElementById("loadingState").classList.remove("hidden");
        document.getElementById("socialProof").classList.add("hidden"); 

        const loadingTexts = [
            "正在沟通天地...", 
            "正在排盘推演 (预计需30秒)...", 
            "正在连接时空能量...", 
            "大师正在斟酌用词...",
            "正在撰写批注...",
            "即将完成..."
        ];
        let step = 0;
        const loadingInterval = setInterval(() => {
            if(step < loadingTexts.length) {
                document.getElementById("loadingText").innerText = loadingTexts[step];
                step++;
            }
        }, 3000); 

        try {
            const minWait = new Promise(resolve => setTimeout(resolve, 3000));
            const aiTask = callAI(isUnlocked);
            
            await Promise.all([minWait, aiTask]);
            
            clearInterval(loadingInterval);
            showResultPage(isUnlocked);
            
        } catch (error) {
            console.error("流程异常，启用本地兜底", error);
            clearInterval(loadingInterval);
            showResultPage(isUnlocked);
        }
    }

    function showResultPage(isUnlocked) {
        document.getElementById("loadingState").classList.add("hidden");
        document.getElementById("resultSection").classList.remove("hidden");
        
        if(!currentStages || currentStages.length === 0) updateTimeDisplay();
        document.getElementById("teaserGod1").innerText = currentStages[0].name;
        document.getElementById("teaserGod2").innerText = currentStages[1].name;
        document.getElementById("teaserGod3").innerText = currentStages[2].name;
        
        let goodCount = currentStages.filter(g => g.type === '吉').length;
        let verdict = "平稳之象";
        if (goodCount >= 2) verdict = "上吉之卦";
        if (currentStages[2].name === '速喜') verdict = "心想事成";
        if (currentStages[2].name === '大安') verdict = "安稳如意";
        
        const verdictEl = document.getElementById("teaserVerdict");
        verdictEl.innerText = verdict;
        verdictEl.className = goodCount >= 2 ? "text-xl text-gold font-bold tracking-widest font-serif" : "text-xl text-white font-bold tracking-widest font-serif";

        if(isUnlocked) {
            unlockContent();
        } else {
            const rawQ = document.getElementById("questionInput").value.trim();
            if (rawQ.toLowerCase().includes(CONFIG.discountCode.toLowerCase())) {
                const btn1 = document.getElementById("btn-tier-1");
                const price1 = document.getElementById("price-tier-1");
                const label1 = document.getElementById("label-tier-1");
                
                price1.innerText = "¥ " + CONFIG.discountPrice;
                price1.classList.add("text-red-400");
                label1.innerText = "粉丝特权";
                label1.classList.add("text-red-300");
                
                btn1.onclick = function() { startPayment(CONFIG.discountPrice); };
                btn1.classList.add("border-red-500/50"); 
            }
        }
    }

    function unlockContent() {
        const blurEl = document.getElementById("paidContentBlur");
        const overlayEl = document.getElementById("payOverlay");
        
        blurEl.classList.remove("blur-lock");
        blurEl.classList.add("blur-unlock");
        blurEl.style.opacity = "1";
        
        overlayEl.style.opacity = "0";
        setTimeout(() => {
            overlayEl.style.display = "none";
        }, 500);
        
        document.getElementById("resultActions").classList.remove("hidden");
    }

    // --- 5. 支付逻辑 ---
    function startPayment(amount) {
        let finalQ = userQuestion;
        CONFIG.vipCodes.forEach(code => {
             finalQ = finalQ.replace(new RegExp(code, "gi"), "");
        });
        if(!finalQ.trim()) finalQ = "综合运势分析";

        localStorage.setItem('cf_question', finalQ);
        localStorage.setItem('cf_timestamp', new Date().getTime());

        const baseUrl = window.location.href.split('?')[0];
        const returnUrl = `${baseUrl}?status=paid`; 

        const payData = {
            pid: CONFIG.paymentId,
            money: amount, 
            name: "春风阁VIP深度测算报告",
            notify_url: CONFIG.notifyUrl,
            out_trade_no: new Date().getTime() + Math.floor(Math.random() * 1000),
            return_url: returnUrl,
            sitename: "春风阁",
            type: "alipay" 
        };

        const form = document.createElement('form');
        form.method = 'POST';
        form.action = CONFIG.submitUrl;
        form.target = '_self'; 
        
        Object.keys(payData).forEach(key => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = key;
            input.value = payData[key];
            form.appendChild(input);
        });
        
        // 计算MD5 (依赖 blueimp-md5)
        // 注意：这里需要重新手动排序拼接参数，因为 Form 提交不会自己算签名
